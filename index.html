<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>G·ªôp Excel ‚Üí Xu·∫•t N+1 file theo d√£y ‚ÄúL∆∞·ª£t b√°n‚Äù</title>
  <style>
    :root{--bg:#0b1020;--card:#121830;--muted:#7c8db5;--txt:#e9eefb;--line:#1b2340}
    body{font:14px/1.5 system-ui,Roboto,Arial;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    h1{margin:0 0 8px}
    .card{background:#121830;border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
    input[type=file], input[type=text]{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:1px solid #223;background:#0d1330;color:var(--txt)}
    button{margin:6px 4px;padding:10px 14px;border-radius:8px;border:1px solid #235;background:#1b2550;color:#fff;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-block;margin:2px;padding:4px 10px;background:#0e1a42;border:1px solid #223;border-radius:999px;font-size:12px;color:#a8b4d6}
    .note{color:var(--muted);font-size:13px}
    #bucketCounts .pill{margin-right:6px}
    .grid{display:grid;gap:10px}
    .grid-2{grid-template-columns:1fr 1fr}
    label.inline{display:inline-flex;align-items:center;gap:6px}
  </style>

  <!-- (Tu·ª≥ ch·ªçn) D√ÅN N·ªòI DUNG xlsx.full.min.js v√†o ƒë√¢y ƒë·ªÉ ch·∫°y OFFLINE 100% -->
  <script id="SHEETJS_INLINE" type="text/plain">
/* === SHEETJS_INLINE_START ===
   D√ÅN TO√ÄN B·ªò N·ªòI DUNG xlsx.full.min.js V√ÄO ƒê√ÇY N·∫æU MU·ªêN "1 FILE HO√ÄN TO√ÄN" (OFFLINE).
   N·∫øu ƒë·ªÉ tr·ªëng, loader b√™n d∆∞·ªõi s·∫Ω t·ª± t·∫£i t·ª´ nhi·ªÅu CDN (kh√¥ng c·ªë ƒë·ªãnh version).
=== SHEETJS_INLINE_END === */
  </script>
</head>
<body>
<div class="wrap">
  <h1>üìä G·ªôp Excel ‚Üí Xu·∫•t nh√≥m theo d√£y ‚ÄúL∆∞·ª£t b√°n‚Äù (linh ho·∫°t)</h1>

  <section class="card">
    <p class="note">
      C·ªôt A: ch·∫•p nh·∫≠n ti√™u ƒë·ªÅ <code>L∆∞·ª£t b√°n ‚â• X</code>, <code>L∆∞·ª£t b√°n X - Y</code>, <code>L∆∞·ª£t b√°n ‚â• X v√† &lt; Y</code>, <code>L∆∞·ª£t b√°n &lt; Z</code>‚Ä¶ D∆∞·ªõi m·ªói ti√™u ƒë·ªÅ l√† list link.
      B·∫°n c√≥ th·ªÉ nh·∫≠p d√£y ng∆∞·ª°ng ƒë·ªÉ t√°i-bucket linh ho·∫°t (m·∫∑c ƒë·ªãnh: 1000,750,500,350,150,60,40,20,5,1).
    </p>

    <div class="grid grid-2">
      <div>
        <input type="file" id="excelFiles" accept=".xls,.xlsx,.csv" multiple>
        <label class="inline"><input id="stripParams2" type="checkbox" checked> Chu·∫©n ho√° URL khi tr√πng (b·ªè query/hash)</label>
        <div id="fileList"></div>
      </div>

      <div>
        <label>D√£y ng∆∞·ª°ng (gi·∫£m d·∫ßn):</label>
        <input id="thresholdsInput" type="text" value="1000,750,500,350,150,60,40,20,5,1" />
        <div class="note">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën t·ª± suy t·ª´ ti√™u ƒë·ªÅ trong file.</div>
      </div>
    </div>

    <button id="btnProcess">X·ª≠ l√Ω & Xu·∫•t theo d√£y</button>
    <div id="mergeStatus" class="note"></div>
    <div id="bucketCounts"></div>
  </section>
</div>

<script>
/* ================== SheetJS bootstrap (inline ho·∫∑c CDN) ================== */
(async function bootstrapXLSX(){
  if (window.XLSX) return;
  const inline = document.getElementById('SHEETJS_INLINE')?.textContent || '';
  if (inline && /xlsx\.(?:version|utils|read)/.test(inline)) { (0, eval)(inline); return; }
  const cdnList = [
    "https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://fastly.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx/dist/xlsx.full.min.js",
    "https://esm.run/xlsx",
    "https://esm.sh/xlsx"
  ];
  for (const src of cdnList) {
    try {
      if (src.endsWith('.js')) {
        await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(); s.onerror=()=>rej(); document.head.appendChild(s); });
      } else {
        const mod = await import(src);
        if (mod && (mod.read || mod.utils)) window.XLSX = mod;
      }
      if (window.XLSX) return;
    } catch(e){}
  }
  console.warn('Kh√¥ng t·∫£i ƒë∆∞·ª£c SheetJS t·ª´ CDN. ƒê·ªÉ ch·∫°y offline 100%, h√£y d√°n xlsx.full.min.js v√†o placeholder SHEETJS_INLINE.');
})();

/* ================== Helpers ================== */
function tryParseURL(u){try{return new URL(u.trim())}catch{return null}}
function normalizeURL(u, drop=true){ const url=tryParseURL(u); if(!url) return (u||'').trim(); if(drop){url.search=''; url.hash='';} url.hostname=url.hostname.toLowerCase(); return url.toString(); }
function num(s){ return s==null?NaN:parseFloat(String(s).replace(',', '.').replace(/\s+/g,'')); }
function fmt(n){ if (!isFinite(n)) return (n>0?'+‚àû':'-‚àû'); return (Math.round(n)===n)? String(n): String(n).replace('.', ','); }
function uniqSortedDesc(nums){ return [...new Set(nums.filter(x=>isFinite(x)))].sort((a,b)=>b-a); }

/** ‚úÖ S·ª¨A L·ªñI: ∆Øu ti√™n m·∫´u 2 bi√™n tr∆∞·ªõc (‚â• A v√† < B, ho·∫∑c A - B), r·ªìi m·ªõi ƒë·∫øn < Z v√† ‚â• X */
function parseHeaderToRange(line){
  const s=(line||'').replace(/\s+/g,' ').trim();
  if(!/l∆∞·ª£t b√°n/i.test(s)) return null;

  // 1) "‚â• A v√† < B" (h·ªó tr·ª£ ">=, ‚â•" v√† "<")
  let m = s.match(/l∆∞·ª£t b√°n\s*(?:‚â•|>=|&ge;|&amp;ge;)\s*([\d.,]+)\s*(?:v√†|and)?\s*(?:<|&lt;)\s*([\d.,]+)/i);
  if (m) {
    const a=num(m[1]), b=num(m[2]);
    if(isFinite(a)&&isFinite(b)){ const low=Math.min(a,b), up=Math.max(a,b); return { low, up }; }
  }

  // 2) "A - B"  (ch·∫•p nh·∫≠n th·ª© t·ª± b·∫•t k·ª≥)
  m = s.match(/l∆∞·ª£t b√°n\s*([\d.,]+)\s*[-‚Äì]\s*([\d.,]+)/i);
  if (m) {
    let a=num(m[1]), b=num(m[2]);
    if(isFinite(a)&&isFinite(b)){ const low=Math.min(a,b), up=Math.max(a,b); return { low, up }; }
  }

  // 3) "< Z"
  m = s.match(/l∆∞·ª£t b√°n\s*(?:<|&lt;)\s*([\d.,]+)/i);
  if (m) {
    const z=num(m[1]);
    if(isFinite(z)) return { low:-Infinity, up:z };
  }

  // 4) "‚â• X" / "> X"
  m = s.match(/l∆∞·ª£t b√°n\s*(?:‚â•|>=|&ge;|&amp;ge;|>|&gt;)\s*([\d.,]+)/i);
  if (m) {
    const x=num(m[1]);
    if(isFinite(x)) return { low:x, up:Infinity };
  }

  return null;
}

function keyOfRange(r){ const l = isFinite(r.low)? r.low : (r.low===-Infinity?'NEG_INF':'UNK'); const u = isFinite(r.up)? r.up : (r.up===Infinity?'POS_INF':'UNK'); return `${l}|${u}`; }
function rangesIntersect(a,b){
  const lowA = isFinite(a.low)? a.low : -Infinity, upA = isFinite(a.up)? a.up : Infinity;
  const lowB = isFinite(b.low)? b.low : -Infinity, upB = isFinite(b.up)? b.up : Infinity;
  return lowA < upB && lowB < upA; // [low, up) giao nhau
}

/* ================== ƒê·ªçc Excel ================== */
const excelInput=document.getElementById('excelFiles');
const fileList=document.getElementById('fileList');
excelInput.onchange=()=>{ fileList.innerHTML=''; for(const f of excelInput.files){ const s=document.createElement('span'); s.className='pill'; s.textContent=f.name; fileList.appendChild(s); } };

async function parseExcel(file){
  if (!window.XLSX) throw new Error('SheetJS ch∆∞a s·∫µn s√†ng (h√£y b·∫≠t m·∫°ng ho·∫∑c d√°n inline).');
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:'',blankrows:false});

  const lines=[];
  for(const r of rows){
    const a=(r&&r[0]!=null?String(r[0]):'').trim();
    if(!a) continue;
    const parts=a.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    for(const p of parts) lines.push(p);
  }

  const bucketsMap = new Map(); // key -> {range, links:Set}
  let currentRange = null;

  for (const line of lines){
    const range = parseHeaderToRange(line);
    if (range){
      currentRange = range;
      const k = keyOfRange(range);
      if (!bucketsMap.has(k)) bucketsMap.set(k, { range, links: new Set() });
      continue;
    }
    if (currentRange && /^https?:\/\//i.test(line)) {
      const k = keyOfRange(currentRange);
      bucketsMap.get(k).links.add(line.trim());
    }
  }
  return bucketsMap;
}

/* ================== G·ªôp & t√°i-bucket theo d√£y ================== */
function dedupeAndNormalizeSets(map, dropParams){
  const out=new Map();
  for (const [k, obj] of map.entries()){
    const set=new Set();
    for (const u of obj.links) set.add(normalizeURL(u, dropParams));
    out.set(k, { range: obj.range, links: set });
  }
  return out;
}
function unifyBucketsAcrossFiles(listOfMaps){
  const merged = new Map();
  for (const mp of listOfMaps){
    for (const [k, obj] of mp.entries()){
      if (!merged.has(k)) merged.set(k, { range: obj.range, links: new Set() });
      const dest = merged.get(k);
      for (const u of obj.links) dest.links.add(u);
    }
  }
  return merged;
}
function buildOutputRangesFromThresholds(thrs){
  const out=[];
  if (!thrs.length) return out;
  let prev = Infinity;
  for (const t of thrs){
    out.push({ low:t, up:prev }); // [t, prev)
    prev = t;
  }
  out.push({ low:-Infinity, up: thrs[thrs.length-1] }); // (-‚àû, last)
  return out;
}
function labelOfRange(r){
  const low=isFinite(r.low)? r.low : -Infinity;
  const up =isFinite(r.up )? r.up  : Infinity;
  if (up===Infinity) return `L∆∞·ª£t b√°n ‚â• ${fmt(low)}`;
  if (low===-Infinity) return `L∆∞·ª£t b√°n < ${fmt(up)}`;
  return `L∆∞·ª£t b√°n t·ª´ ${fmt(low)} ƒë·∫øn ${fmt(up)}`;
}

/* ================== Xu·∫•t Excel ================== */
async function saveXLSX(name, links){
  if (!window.XLSX) throw new Error('SheetJS ch∆∞a s·∫µn s√†ng.');
  const ws=XLSX.utils.aoa_to_sheet(links.map(x=>[x]));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Links');
  XLSX.writeFile(wb,name,{compression:true});
}

/* ================== Orchestrator ================== */
const btnProcess=document.getElementById('btnProcess');
const statusMerge=document.getElementById('mergeStatus');
const bucketCounts=document.getElementById('bucketCounts');
const thresholdsInput=document.getElementById('thresholdsInput');

btnProcess.onclick=async()=>{
  const files=[...excelInput.files];
  if(!files.length){ statusMerge.textContent='H√£y ch·ªçn √≠t nh·∫•t 1 file Excel.'; return; }

  statusMerge.textContent='ƒêang ƒë·ªçc & g·ªôp d·ªØ li·ªáu‚Ä¶';
  btnProcess.disabled=true; bucketCounts.innerHTML='';

  const parsedMaps=[];
  for(const f of files){
    try{
      const mp = await parseExcel(f);
      parsedMaps.push(mp);
    }catch(e){ console.error('L·ªói file', f.name, e); }
  }

  const mergedRaw = unifyBucketsAcrossFiles(parsedMaps);
  const merged = dedupeAndNormalizeSets(mergedRaw, document.getElementById('stripParams2').checked);

  // L·∫•y d√£y ng∆∞·ª°ng (n·∫øu nh·∫≠p) ho·∫∑c t·ª± suy
  let thrs = String(thresholdsInput.value||'').split(',')
              .map(s=>num(s)).filter(x=>isFinite(x));
  thrs = uniqSortedDesc(thrs);

  if (!thrs.length){
    const lows=[];
    for (const {range} of merged.values()){
      if (isFinite(range.low)) lows.push(range.low);
    }
    thrs = uniqSortedDesc(lows);
    statusMerge.innerHTML = thrs.length
      ? `T·ª± suy ra d√£y ng∆∞·ª°ng: ${thrs.join(', ')}`
      : 'Kh√¥ng t√¨m th·∫•y ng∆∞·ª°ng n√†o. S·∫Ω xu·∫•t 1 file ‚ÄúKh√¥ng x√°c ƒë·ªãnh‚Äù.';
    if (!thrs.length){
      const allLinks = new Set();
      for (const obj of merged.values()) for (const u of obj.links) allLinks.add(u);
      await saveXLSX(`Khong xac dinh.xlsx`, [...allLinks]);
      btnProcess.disabled=false; return;
    }
  } else {
    statusMerge.innerHTML = `D√πng d√£y ng∆∞·ª°ng: ${thrs.join(', ')}`;
  }

  const outRanges = buildOutputRangesFromThresholds(thrs);
  const outMap = new Map(outRanges.map(r=>[labelOfRange(r), new Set()]));

  // Ph√¢n b·ªï: v·ªõi d·ªØ li·ªáu chu·∫©n (c√°c kho·∫£ng r·ªùi nhau), m·ªói nh√≥m input ch·ªâ kh·ªõp ƒë√∫ng 1 outRange
  let crossDupWarnings = 0;
  for (const {range:rangeIn, links} of merged.values()){
    let touched = 0;
    for (const rOut of outRanges){
      if (rangesIntersect(rangeIn, rOut)){
        const dest = outMap.get(labelOfRange(rOut));
        for (const u of links) dest.add(u);
        touched++;
      }
    }
    if (touched>1) crossDupWarnings++; // s·∫Ω = 0 v·ªõi file b·∫°n g·ª≠i
  }

  // Xu·∫•t file theo th·ª© t·ª± t·ª´ l·ªõn xu·ªëng nh·ªè; b·ªè bucket r·ªóng
  let exported = 0;
  for (const rOut of outRanges){
    const label = labelOfRange(rOut);
    const links = [...(outMap.get(label) || new Set())];
    if (!links.length) continue;
    await saveXLSX(`${label}.xlsx`, links);
    exported++;
  }

  // Th·ªëng k√™
  const mk=(label,n)=>{const s=document.createElement('span');s.className='pill';s.textContent=`${label}: ${n}`;return s};
  for (const rOut of outRanges){
    const label = labelOfRange(rOut);
    const n = (outMap.get(label)||new Set()).size;
    bucketCounts.append(mk(label, n));
  }

  let note = `‚úÖ ƒê√£ xu·∫•t ${exported} file (m·ªói d√≤ng 1 link).`;
  if (crossDupWarnings>0) note += ` L∆∞u √Ω: C√≥ ${crossDupWarnings} nh√≥m giao nhau (ti√™u ƒë·ªÅ ch·ªìng l·∫•n).`;
  statusMerge.innerHTML += (statusMerge.innerHTML?' ':'') + note;

  btnProcess.disabled=false;
};
</script>
</body>
</html>
