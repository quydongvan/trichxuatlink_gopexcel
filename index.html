<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gộp nhiều Excel → Xuất 4 file theo nhóm "Lượt bán"</title>
  <style>
    :root{--bg:#0b1020;--card:#121830;--muted:#7c8db5;--txt:#e9eefb;--line:#1b2340}
    body{font:14px/1.5 system-ui,Roboto,Arial;background:var(--bg);color:var(--txt);margin:0}
    .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
    h1{margin:0 0 8px}
    .card{background:#121830;border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
    input[type=file]{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:1px solid #223;background:#0d1330;color:var(--txt)}
    button{margin:6px 4px;padding:10px 14px;border-radius:8px;border:1px solid #235;background:#1b2550;color:#fff;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-block;margin:2px;padding:4px 10px;background:#0e1a42;border:1px solid #223;border-radius:999px;font-size:12px;color:#a8b4d6}
    .note{color:var(--muted);font-size:13px}
    #bucketCounts .pill{margin-right:6px}
  </style>

  <!-- (Tuỳ chọn) DÁN NỘI DUNG xlsx.full.min.js vào đây để chạy OFFLINE 100% -->
  <script id="SHEETJS_INLINE" type="text/plain">
/* === SHEETJS_INLINE_START ===
   DÁN TOÀN BỘ NỘI DUNG xlsx.full.min.js VÀO ĐÂY NẾU MUỐN "1 FILE HOÀN TOÀN" (OFFLINE).
   Nếu để trống, loader bên dưới sẽ tự tải từ nhiều CDN (không cố định version).
=== SHEETJS_INLINE_END === */
  </script>
</head>
<body>
<div class="wrap">
  <h1>📊 Gộp nhiều Excel → Xuất 4 file theo nhóm “Lượt bán”</h1>

  <section class="card">
    <p class="note">Cấu trúc cột A: các tiêu đề theo thứ tự “Lượt bán &gt; X”, “Lượt bán X - Y”, “Lượt bán Y - Z”, “Lượt bán &lt; Z”; dưới mỗi tiêu đề là danh sách link (có thể có dòng trống). Công cụ tự nhận diện X, Y, Z.</p>
    <div>
      <input type="file" id="excelFiles" accept=".xls,.xlsx,.csv" multiple>
      <label class="pill"><input id="stripParams2" type="checkbox" checked> Chuẩn hoá URL khi trùng (bỏ query/hash)</label>
    </div>
    <button id="btnProcess">Xử lý & Xuất 4 file</button>
    <div id="fileList"></div>
    <div id="mergeStatus" class="note"></div>
    <div id="bucketCounts"></div>
  </section>
</div>

<script>
/* ================== SheetJS bootstrap (inline hoặc CDN không cố định version) ================== */
(async function bootstrapXLSX(){
  if (window.XLSX) return;
  const inline = document.getElementById('SHEETJS_INLINE')?.textContent || '';
  if (inline && /xlsx\.(?:version|utils|read)/.test(inline)) { (0, eval)(inline); return; }
  const cdnList = [
    "https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://fastly.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx/dist/xlsx.full.min.js",
    "https://esm.run/xlsx",
    "https://esm.sh/xlsx"
  ];
  for (const src of cdnList) {
    try {
      if (src.endsWith('.js')) {
        await new Promise((res, rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(); s.onerror=()=>rej(); document.head.appendChild(s); });
      } else {
        const mod = await import(src);
        if (mod && (mod.read || mod.utils)) window.XLSX = mod;
      }
      if (window.XLSX) return;
    } catch(e){}
  }
  console.warn('Không tải được SheetJS từ CDN. Để chạy offline 100%, hãy dán xlsx.full.min.js vào placeholder SHEETJS_INLINE.');
})();

/* ================== Helpers ================== */
function tryParseURL(u){try{return new URL(u.trim())}catch{return null}}
function normalizeURL(u, drop=true){ const url=tryParseURL(u); if(!url) return (u||'').trim(); if(drop){url.search=''; url.hash='';} url.hostname=url.hostname.toLowerCase(); return url.toString(); }

const excelInput=document.getElementById('excelFiles');
const fileList=document.getElementById('fileList');
excelInput.onchange=()=>{ fileList.innerHTML=''; for(const f of excelInput.files){ const s=document.createElement('span'); s.className='pill'; s.textContent=f.name; fileList.appendChild(s); } };

function detectHeaderKindAndNums(line){
  const s=line.replace(/\s+/g,' ').trim();
  const nums=(s.match(/\d+(?:[\.,]\d+)?/g)||[]).map(v=>parseFloat(v.replace(',','.')));
  if(/lượt bán\s*>/i.test(s)) return {kind:'gt', nums};
  if(/lượt bán\s*</i.test(s)) return {kind:'lt', nums};
  if(/lượt bán/i.test(s) && /\d+\s*[-–]\s*\d+/.test(s)) return {kind:'range', nums};
  return {kind:null, nums:[]};
}

async function parseExcel(file){
  if (!window.XLSX) throw new Error('SheetJS chưa sẵn sàng (hãy bật mạng hoặc dán inline).');
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:'',blankrows:false});
  const lines=[]; // flatten cột A + tách dòng
  for(const r of rows){ const a=(r&&r[0]!=null?String(r[0]):'').trim(); if(!a) continue; const parts=a.split(/\r?\n/).map(x=>x.trim()).filter(Boolean); for(const p of parts) lines.push(p); }

  const buckets={gt:[], xy:[], yz:[], lt:[]};
  let state=null; let X=null,Y=null,Z=null; let rangeCount=0;
  for(const line of lines){
    const {kind, nums}=detectHeaderKindAndNums(line);
    if(kind){
      if(kind==='gt'){ state='gt'; if(nums.length) X=nums[0]; }
      else if(kind==='range'){ state=(state==='gt'||rangeCount===0)?'xy':'yz'; rangeCount++; if(nums.length>=2){ if(state==='xy'){ X = X ?? nums[0]; Y = nums[1]; } else { Y = Y ?? nums[0]; Z = nums[1]; } } }
      else if(kind==='lt'){ state='lt'; if(nums.length) Z=nums[0]; }
      continue;
    }
    if(/^https?:\/\//i.test(line) && state){ buckets[state].push(line.trim()); }
  }
  return {buckets, thresholds:{X,Y,Z}};
}

function dedupeAndNormalize(buckets, dropParams){
  const out={gt:new Set(), xy:new Set(), yz:new Set(), lt:new Set()};
  for(const k of ['gt','xy','yz','lt']) for(const u of (buckets[k]||[])) out[k].add(normalizeURL(u, dropParams));
  return {gt:[...out.gt], xy:[...out.xy], yz:[...out.yz], lt:[...out.lt]};
}

async function saveXLSX(name, arr){
  if (!window.XLSX) throw new Error('SheetJS chưa sẵn sàng (hãy bật mạng hoặc dán inline).');
  const ws=XLSX.utils.aoa_to_sheet(arr.map(x=>[x]));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Links');
  XLSX.writeFile(wb,name,{compression:true});
}

const btnProcess=document.getElementById('btnProcess');
const statusMerge=document.getElementById('mergeStatus');
const bucketCounts=document.getElementById('bucketCounts');

btnProcess.onclick=async()=>{
  const files=[...excelInput.files]; if(!files.length){statusMerge.textContent='Hãy chọn ít nhất 1 file Excel.';return}
  statusMerge.textContent='Đang đọc & gộp dữ liệu…'; btnProcess.disabled=true; bucketCounts.innerHTML='';

  const merged={gt:[], xy:[], yz:[], lt:[]}; const thresholdsList=[];
  for(const f of files){
    try{
      const {buckets, thresholds}=await parseExcel(f);
      merged.gt.push(...buckets.gt); merged.xy.push(...buckets.xy); merged.yz.push(...buckets.yz); merged.lt.push(...buckets.lt);
      thresholdsList.push(thresholds);
    }catch(e){ console.error('Lỗi file', f.name, e); }
  }

  const deduped=dedupeAndNormalize(merged, document.getElementById('stripParams2').checked);

  // đặt tên: ưu tiên file nào đủ bộ X,Y,Z; nếu thiếu → 50/10/5
  let X=null,Y=null,Z=null; for(const t of thresholdsList){ if(t && t.X!=null && t.Y!=null && t.Z!=null){ X=t.X; Y=t.Y; Z=t.Z; break; } }
  if(X==null||Y==null||Z==null){ X=50; Y=10; Z=5; statusMerge.innerHTML='<span class="note">Không đọc đủ ngưỡng từ tiêu đề — dùng mặc định X=50, Y=10, Z=5.</span>'; }

  await saveXLSX(`Lượt bán Lớn hơn ${X}.xlsx`, deduped.gt);
  await saveXLSX(`Lượt bán từ ${X} đến ${Y}.xlsx`, deduped.xy);
  await saveXLSX(`Lượt bán từ ${Y} đến ${Z}.xlsx`, deduped.yz);
  await saveXLSX(`Lượt bán nhỏ hơn ${Z}.xlsx`, deduped.lt);

  const mk=(label,n)=>{const s=document.createElement('span');s.className='pill';s.textContent=`${label}: ${n}`;return s};
  bucketCounts.append(mk(`> ${X}`, deduped.gt.length));
  bucketCounts.append(mk(`${X} – ${Y}`, deduped.xy.length));
  bucketCounts.append(mk(`${Y} – ${Z}`, deduped.yz.length));
  bucketCounts.append(mk(`< ${Z}`, deduped.lt.length));

  statusMerge.innerHTML += (statusMerge.innerHTML?' ':'') + '✅ Đã xuất đủ 4 file (mỗi dòng 1 link, không tiêu đề).';
  btnProcess.disabled=false;
};
</script>
</body>
</html>
