<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gi·∫£i m√£ Link r√∫t g·ªçn (unique, streaming) & G·ªôp Excel theo ‚ÄúL∆∞·ª£t b√°n‚Äù</title>
<style>
  :root{--bg:#0b1020;--card:#121830;--muted:#8fa1c8;--txt:#e9eefb;--line:#1b2340}
  *{box-sizing:border-box}
  body{font:14px/1.55 system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--txt);margin:0}
  .wrap{max-width:1100px;margin:22px auto;padding:0 16px}
  h1{margin:0 0 8px;font-size:20px} h2{margin:0 0 8px;font-size:18px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;margin:16px 0}
  textarea,input[type=file]{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:1px solid #223;background:#0d1330;color:var(--txt)}
  button{margin:6px 4px;padding:10px 14px;border-radius:8px;border:1px solid #235;background:#1b2550;color:#fff;cursor:pointer}
  button.secondary{background:#2a355f}
  button:disabled{opacity:.55;cursor:not-allowed}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .note{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:8px;margin:2px;padding:4px 10px;background:#0e1a42;border:1px solid #223;border-radius:999px;font-size:12px;color:#a8b4d6}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .list{min-height:160px}
  .counts span{display:inline-block;margin:2px 6px 0 0;padding:4px 8px;border:1px solid #223;border-radius:999px;background:#0e1a42;color:#a8b4d6;font-size:12px}
</style>

<!-- T·ª± n·∫°p SheetJS t·ª´ nhi·ªÅu CDN (kh√¥ng c·ªë ƒë·ªãnh version) -->
<script>
(async function loadXLSX(){
  if (window.XLSX) return;
  const cdns = [
    "https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://fastly.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js",
    "https://unpkg.com/xlsx/dist/xlsx.full.min.js",
    "https://esm.run/xlsx",
    "https://esm.sh/xlsx"
  ];
  for (const src of cdns) {
    try {
      if (src.endsWith(".js")) {
        await new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = src; s.async = true;
          s.onload = () => res();
          s.onerror = () => rej();
          document.head.appendChild(s);
        });
      } else {
        const mod = await import(src);
        if (mod && (mod.read || mod.utils)) window.XLSX = mod;
      }
      if (window.XLSX) return;
    } catch {}
  }
  console.warn("Kh√¥ng t·∫£i ƒë∆∞·ª£c SheetJS t·ª´ CDN. H√£y ƒë·∫£m b·∫£o c√≥ m·∫°ng.");
})();
</script>
</head>
<body>
<div class="wrap">
  <h1>üîó Tr√≠ch xu·∫•t link shopee + G·ªôp excel theo l∆∞·ª£t b√°n</h1>

  <!-- ========== PH·∫¶N 1: GI·∫¢I M√É LINK R√öT G·ªåN (UNIQUE, STREAMING) ========== -->
  <section class="card">
    <h2>1) Gi·∫£i m√£ link r√∫t g·ªçn (ch·ªâ hi·ªÉn th·ªã Link g·ªëc, unique, hi·ªán d·∫ßn t·ª´ng link)</h2>
    <p class="note">M·ªói d√≤ng 1 link r√∫t g·ªçn. K·∫øt qu·∫£ ch·ªâ g·ªìm <b>Link g·ªëc (final)</b>, lo·∫°i tr√πng theo cu·ªëi c√πng.</p>

    <div class="row">
      <label class="pill"><input id="stripParams" type="checkbox" checked> B·ªè query/hash khi so tr√πng</label>
      <span id="status" class="note"></span>
    </div>

    <textarea id="shortInput" placeholder="D√°n danh s√°ch link r√∫t g·ªçn (m·ªói d√≤ng 1 link)‚Ä¶"></textarea>

    <div class="row">
      <button id="btnStart">B·∫Øt ƒë·∫ßu gi·∫£i m√£</button>
      <button id="btnStop" class="secondary" disabled>D·ª´ng</button>
      <button id="btnClear" class="secondary">X√≥a</button>
      <button id="btnCopy" class="secondary" disabled>Copy k·∫øt qu·∫£</button>
    </div>

    <textarea id="finalList" class="mono list" placeholder="K·∫øt qu·∫£ Link g·ªëc (unique) s·∫Ω hi·ªÉn th·ªã d·∫ßn ·ªü ƒë√¢y‚Ä¶" readonly></textarea>
  </section>

  <!-- ========== PH·∫¶N 2: G·ªòP NHI·ªÄU EXCEL ‚Üí XU·∫§T 4 FILE THEO ‚ÄúL∆Ø·ª¢T B√ÅN‚Äù ========== -->
  <section class="card">
    <h2>2) G·ªôp nhi·ªÅu Excel ‚Üí Xu·∫•t 4 file theo nh√≥m ‚ÄúL∆∞·ª£t b√°n‚Äù</h2>
    <p class="note">T·ª± nh·∫≠n di·ªán ti√™u ƒë·ªÅ c·ªôt A ki·ªÉu: ‚ÄúL∆∞·ª£t b√°n &gt; X‚Äù, ‚ÄúL∆∞·ª£t b√°n X - Y‚Äù, ‚ÄúL∆∞·ª£t b√°n Y - Z‚Äù, ‚ÄúL∆∞·ª£t b√°n &lt; Z‚Äù. Li√™n k·∫øt n·∫±m ·ªü c√°c d√≤ng d∆∞·ªõi m·ªói ti√™u ƒë·ªÅ.</p>
    <div class="row">
      <input type="file" id="excelFiles" accept=".xls,.xlsx,.csv" multiple>
      <label class="pill"><input id="stripParams2" type="checkbox" checked> Chu·∫©n ho√° URL khi tr√πng</label>
    </div>
    <div class="row">
      <button id="btnProcess">X·ª≠ l√Ω & Xu·∫•t 4 file</button>
      <div id="fileList" class="note"></div>
    </div>
    <div id="mergeStatus" class="note"></div>
    <div id="bucketCounts" class="counts"></div>
  </section>
</div>

<script>
/* ==================== PH·∫¶N 1: GI·∫¢I M√É LINK R√öT G·ªåN ==================== */
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyRwKn62176OYnKm9nFyGHN1hal57Ud-7jfhNxtfVajYOCnHj07d2KvffmSRrRaDBThrg/exec";

const $ = s => document.querySelector(s);
const els = {
  shortInput: $('#shortInput'),
  stripParams: $('#stripParams'),
  btnStart: $('#btnStart'),
  btnStop: $('#btnStop'),
  btnClear: $('#btnClear'),
  btnCopy: $('#btnCopy'),
  status: $('#status'),
  finalList: $('#finalList'),
};

let stopFlag = false;
const sleep = ms => new Promise(r=>setTimeout(r,ms));

function normalizeURL(u, drop=true){
  try{
    const url = new URL((u||'').trim());
    if (drop) { url.search = ''; url.hash=''; }
    url.hostname = url.hostname.toLowerCase();
    return url.toString();
  }catch{return (u||'').trim();}
}

function lines(t){return (t||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean)}

// ch·∫°y tu·∫ßn t·ª±: xong link n√†o hi·ªán link ƒë√≥
els.btnStart.onclick = async () => {
  const inputs = lines(els.shortInput.value);
  if (!inputs.length) { els.status.textContent = 'H√£y d√°n danh s√°ch link r√∫t g·ªçn.'; return; }

  // reset
  els.finalList.value = '';
  els.status.textContent = `ƒêang x·ª≠ l√Ω 0/${inputs.length}‚Ä¶`;
  els.btnStart.disabled = true; els.btnStop.disabled = false; els.btnCopy.disabled = true;
  stopFlag = false;

  const unique = new Set();  // l∆∞u Link g·ªëc (ƒë√£ chu·∫©n ho√°) ƒë·ªÉ lo·∫°i tr√πng
  const drop = els.stripParams.checked;

  let done = 0;
  for (const u of inputs) {
    if (stopFlag) break;

    try {
      // Simple request: KH√îNG set Content-Type ƒë·ªÉ tr√°nh preflight
      const resp = await fetch(WEB_APP_URL, { method:'POST', body: JSON.stringify({ urls:[u] }) });
      const text = await resp.text();
      let data = null;
      try { data = JSON.parse(text); } catch {}

      const item = Array.isArray(data) ? data[0] : null;
      const final = item && item.finalUrl ? item.finalUrl : '';

      if (final) {
        const norm = normalizeURL(final, drop);
        if (!unique.has(norm)) {
          unique.add(norm);
          // hi·ªÉn th·ªã d·∫ßn
          els.finalList.value += (els.finalList.value ? '\n' : '') + norm;
          els.finalList.scrollTop = els.finalList.scrollHeight;
        }
      }
    } catch (e) {
      // b·ªè qua l·ªói t·ª´ng link
    }

    done++;
    els.status.textContent = `ƒêang x·ª≠ l√Ω ${done}/${inputs.length}‚Ä¶ Unique: ${unique.size}`;
    await sleep(10); // nh∆∞·ªùng UI
  }

  els.status.textContent = `Ho√†n t·∫•t ${done}/${inputs.length}. Unique: ${unique.size}`;
  els.btnStart.disabled = false; els.btnStop.disabled = true;
  els.btnCopy.disabled = unique.size === 0;
};

els.btnStop.onclick = () => { stopFlag = true; els.btnStop.disabled = true; };
els.btnClear.onclick = () => {
  els.shortInput.value = '';
  els.finalList.value = '';
  els.status.textContent = '';
  els.btnCopy.disabled = true;
};
els.btnCopy.onclick = async () => {
  try {
    await navigator.clipboard.writeText(els.finalList.value || '');
    els.status.textContent = '‚úÖ ƒê√£ copy danh s√°ch Link g·ªëc.';
  } catch {
    els.status.textContent = '‚ö†Ô∏è Kh√¥ng copy ƒë∆∞·ª£c.';
  }
};

/* ==================== PH·∫¶N 2: G·ªòP EXCEL ‚Üí 4 FILE ==================== */
const excelInput = document.getElementById('excelFiles');
const fileList   = document.getElementById('fileList');
const btnProcess = document.getElementById('btnProcess');
const stripParams2 = document.getElementById('stripParams2');
const mergeStatus  = document.getElementById('mergeStatus');
const bucketCounts = document.getElementById('bucketCounts');

excelInput.onchange = () => {
  fileList.textContent = [...excelInput.files].map(f=>f.name).join(', ');
};

function detectHeaderKindAndNums(line){
  const s=line.replace(/\s+/g,' ').trim();
  const nums=(s.match(/\d+(?:[.,]\d+)?/g)||[]).map(v=>parseFloat(v.replace(',','.')));
  if(/l∆∞·ª£t b√°n\s*>/i.test(s)) return {kind:'gt', nums};
  if(/l∆∞·ª£t b√°n\s*</i.test(s)) return {kind:'lt', nums};
  if(/l∆∞·ª£t b√°n/i.test(s) && /\d+\s*[-‚Äì]\s*\d+/.test(s)) return {kind:'range', nums};
  return {kind:null, nums:[]};
}

async function parseExcel(file){
  if (!window.XLSX) throw new Error("SheetJS ch∆∞a s·∫µn s√†ng (h√£y ƒë·∫£m b·∫£o c√≥ m·∫°ng).");
  const buf=await file.arrayBuffer();
  const wb=XLSX.read(buf,{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:'',blankrows:false});

  const lines=[]; // r·∫£i c√°c d√≤ng t·ª´ c·ªôt A (c√≥ th·ªÉ ng·∫Øt d√≤ng trong 1 √¥)
  for(const r of rows){
    const a=(r&&r[0]!=null?String(r[0]):'').trim();
    if(!a) continue;
    const parts=a.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    for(const p of parts) lines.push(p);
  }

  const buckets={gt:[], xy:[], yz:[], lt:[]};
  let state=null; let X=null,Y=null,Z=null; let rangeCount=0;

  for(const line of lines){
    const {kind, nums}=detectHeaderKindAndNums(line);
    if(kind){
      if(kind==='gt'){ state='gt'; if(nums.length) X=nums[0]; }
      else if(kind==='range'){
        state=(state==='gt'||rangeCount===0)?'xy':'yz'; rangeCount++;
        if(nums.length>=2){
          if(state==='xy'){ X = X ?? nums[0]; Y = nums[1]; }
          else { Y = Y ?? nums[0]; Z = nums[1]; }
        }
      } else if(kind==='lt'){ state='lt'; if(nums.length) Z=nums[0]; }
      continue;
    }
    if(/^https?:\/\//i.test(line) && state){ buckets[state].push(line.trim()); }
  }
  return {buckets, thresholds:{X,Y,Z}};
}

function dedupeAndNormalize(buckets, dropParams){
  const out={gt:new Set(), xy:new Set(), yz:new Set(), lt:new Set()};
  const norm = u => normalizeURL(u, dropParams);
  for(const k of ['gt','xy','yz','lt']) for(const u of (buckets[k]||[])) out[k].add(norm(u));
  return {gt:[...out.gt], xy:[...out.xy], yz:[...out.yz], lt:[...out.lt]};
}

async function saveXLSX(name, arr){
  if (!window.XLSX) throw new Error("SheetJS ch∆∞a s·∫µn s√†ng (h√£y ƒë·∫£m b·∫£o c√≥ m·∫°ng).");
  const ws=XLSX.utils.aoa_to_sheet(arr.map(x=>[x]));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Links');
  XLSX.writeFile(wb,name,{compression:true});
}

btnProcess.onclick = async () => {
  const files=[...excelInput.files];
  if(!files.length){ mergeStatus.textContent='H√£y ch·ªçn √≠t nh·∫•t 1 file Excel.'; return; }

  btnProcess.disabled=true; mergeStatus.textContent='ƒêang ƒë·ªçc & g·ªôp d·ªØ li·ªáu‚Ä¶';
  bucketCounts.innerHTML='';

  const merged={gt:[], xy:[], yz:[], lt:[]}; const thresholdsList=[];
  for(const f of files){
    try{
      const {buckets, thresholds}=await parseExcel(f);
      merged.gt.push(...buckets.gt); merged.xy.push(...buckets.xy);
      merged.yz.push(...buckets.yz); merged.lt.push(...buckets.lt);
      thresholdsList.push(thresholds);
    }catch(e){ console.error('L·ªói file', f.name, e); }
  }

  const deduped = dedupeAndNormalize(merged, stripParams2.checked);

  // ch·ªçn ng∆∞·ª°ng ƒë·ªçc ƒë∆∞·ª£c ƒë·∫ßu ti√™n ƒë·ªß X,Y,Z, n·∫øu kh√¥ng c√≥ ‚Üí m·∫∑c ƒë·ªãnh
  let X=null,Y=null,Z=null;
  for(const t of thresholdsList){ if(t && t.X!=null && t.Y!=null && t.Z!=null){ X=t.X; Y=t.Y; Z=t.Z; break; } }
  if(X==null||Y==null||Z==null){ X=50; Y=10; Z=5; mergeStatus.innerHTML='Kh√¥ng ƒë·ªçc ƒë·ªß ng∆∞·ª°ng t·ª´ ti√™u ƒë·ªÅ ‚Äî d√πng m·∫∑c ƒë·ªãnh X=50, Y=10, Z=5.'; }

  await saveXLSX(`L∆∞·ª£t b√°n L·ªõn h∆°n ${X}.xlsx`, deduped.gt);
  await saveXLSX(`L∆∞·ª£t b√°n t·ª´ ${X} ƒë·∫øn ${Y}.xlsx`, deduped.xy);
  await saveXLSX(`L∆∞·ª£t b√°n t·ª´ ${Y} ƒë·∫øn ${Z}.xlsx`, deduped.yz);
  await saveXLSX(`L∆∞·ª£t b√°n nh·ªè h∆°n ${Z}.xlsx`, deduped.lt);

  const mk=(label,n)=>{const s=document.createElement('span');s.textContent=`${label}: ${n}`;return s};
  bucketCounts.append(mk(`> ${X}`, deduped.gt.length));
  bucketCounts.append(mk(`${X} ‚Äì ${Y}`, deduped.xy.length));
  bucketCounts.append(mk(`${Y} ‚Äì ${Z}`, deduped.yz.length));
  bucketCounts.append(mk(`< ${Z}`, deduped.lt.length));

  mergeStatus.innerHTML += (mergeStatus.innerHTML?' ':'') + '‚úÖ ƒê√£ xu·∫•t ƒë·ªß 4 file.';
  btnProcess.disabled=false;
};
</script>
</body>
</html>
